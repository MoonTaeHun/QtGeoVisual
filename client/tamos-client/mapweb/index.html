<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TAMOS Map</title>
    <meta name="referrer" content="no-referrer">

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=30fb0eda4415c52ecd7b2f2d059f067e&autoload=false&libraries=drawing"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script><!--KakaoMap Plugin Heatmap(third-party)-->
    <script src="https://unpkg.com/deck.gl@8.9.3/dist.min.js"></script><!--Mapbox Plugin deck.gl(thrid-party)-->

    <script src="js/qwebchannel.js"></script>
    <script src="js/StyleConfig.js"></script>
    <script src="js/ShapeManager.js"></script>
    <script src="js/MapAdapter.js"></script>
    <script src="js/KakaoAdapter.js"></script>
    <script src="js/MapboxAdapter.js"></script>
    <script src="js/MapManager.js"></script>

    <script>
        window.mapBridge = null;

        // 1. Qt 채널 연결을 먼저 시도합니다.
        function initializeWebChannel() {
            if (typeof qt !== 'undefined' && qt.webChannelTransport) {
                new QWebChannel(qt.webChannelTransport, function (channel) {
                    window.mapBridge = channel.objects.mapBridge;
                    console.log("Qt WebChannel Connected successfully! Object:", window.mapBridge);

                    // 2. [핵심] 채널 연결이 성공한 직후에 지도를 초기화합니다.
                    initMapManager();
                });
            } else {
                console.warn("Waiting for 'qt' object to be injected...");
                setTimeout(initializeWebChannel, 100);
            }
        }

        // 지도를 띄우는 함수를 분리합니다.
        function initMapManager() {
            mapManager.init('map', { lat: 37.5546, lng: 126.9706 });
        }

        // DOMContentLoaded 이벤트를 사용하여 안전하게 시작합니다.
        document.addEventListener('DOMContentLoaded', initializeWebChannel);
    </script>

    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }

        /* [추가] 드론 마커 스타일 (빨간색 원) */
        .drone-marker {
            width: 20px;
            height: 20px;
            background-color: #ff0000;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="map"></div>
</body>
</html>
